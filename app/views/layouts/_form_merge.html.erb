<%# NOTE: Argument "models" should be an 2-element Array of base-model and merge-model %>

  <% if models[0].errors.any? || models[1].errors.any? %>
    <div id="error_explanation">
      <h2>merging failed:</h2>

      <ul>
        <% models.each do |eam| %>
          <li><%= errors.full_messages %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

<% is_music = (models[0].class == Music) %>
<% model_underscore = models[0].class.name.underscore %>
<% path_update = send(model_underscore.pluralize + "_update_merge_users_path", models[0]) %> <%# e.g., musics_update_merge_users_path() %>
<%= form_with(model: models[0], url: path_update, method: "patch") do |form| %>
<table>
  <thead>
    <tr><th></th>
      <% models.each do |em| %>
      <th>ID=<%= link_to em.id, send(model_underscore+"_path", em.id) %><br><%= em.title_or_alt %></th>
      <% end %>
  </thead>
  <tbody>
    <tr><th>Merge to</th>
      <% models.each_index do |i| %>
      <td style="text-align: center;"><%= form.radio_button(BaseMergesController::FORM_MERGE[:to_index], i, checked: (i==0)) %>
      </td>
      <% end %>
    </tr>
    <tr><th>Orig-Language</th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:lang_orig] %>
        <%= form.radio_button(labe, i, checked: (i==0)) %>
        <% trans = em.orig_translation %>
        <% arstr = %i(title ruby romaji alt_title alt_ruby alt_romaji).map{|et| h(trans.send(et) || "?")} %>
        <% alt_head = '<span class="font-smaller">['+h(t(:alt_title).capitalize)+']</span>' %>
        <% ruby_head = '<span class="font-smaller">'+h(t(:ruby_short).capitalize)+'</span>' %>
        <% str = sprintf("%s<br>#{ruby_head}(%s | %s)<br>#{alt_head} %s<br>#{ruby_head}(%s | %s)", *arstr).html_safe %>
        <%= form.label labe, str, :value => i %>
      </td>
      <% end %>
    </tr>
    <tr><th><%= t(:Translation, count: 2, default: 'Translations') %></th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:lang_trans] %>
        <% orig_trans = em.orig_translation %>
        <% exist_editable = em.translations.any?{|et| (et != orig_trans) && can?(:ud, Translation)} %>
        <% exist_editable = em.translations.any?{|et| (et != orig_trans) && can?(:ud, et)} %>
        <% if exist_editable %>
          <%= form.radio_button(labe, i, checked: (i==0)) %>
        <% end %>
        <% arstr = [] %>
        <% em.translations.sort{|a, b|
            (I18n.available_locales.find_index(a.langcode.to_sym) || Float::INFINITY)
           }.each do |et| %>
          <% next if et.langcode == orig_trans.langcode %>
          <% arstr << sprintf("%s / %s", h(et.title), h(et.alt_title)) %>
        <% end %>
        <% str = arstr.join("<br>").html_safe %>
        <% if exist_editable %>
          <%= form.label labe, str, :value => i %>
        <% else %>
          <span style="padding-left: 2em;"><%= str %></span>
        <% end %>
      </td>
      <% end %>
    </tr>
    <% engage_other_underscore = (is_music ? 'Artist' : 'Music').underscore %>
    <tr><th>Engage-<%= engage_other_underscore.camelize.pluralize %></th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:engage] %>
        <%= form.radio_button(labe, i, checked: (i==0)) %>
        <% str = em.engages.map{ |een|
             linkmodel = een.send(engage_other_underscore)
             linkpath = send(engage_other_underscore+"_path", linkmodel)
             sprintf(
                "%s (%s[%s] %s)",
                link_to(linkmodel.title_or_alt, linkpath),
                h(een.engage_how.title_or_alt(langcode: I18n.locale)),
                h(short_float_str(een.contribution, maxlength: 4, str_nil: "?")),
                h(een.year.inspect)
             )
           }.join("<br>").html_safe %>
        <%= form.label labe, str, :value => i %>
      </td>
      <% end %>
    </tr>
    <tr><th>Prefecture (Country)</th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:prefecture_place] %>
        <%= form.radio_button(labe, i, checked: (i==0)) %>
        <% str = sprintf("%s (%s)", h(em.place.prefecture.title_or_alt(langcode: I18n.locale)), h(em.place.country.title_or_alt(langcode: I18n.locale))).html_safe %>
        <%= form.label labe, str, :value => i %>
      </td>
      <% end %>
    </tr>
  <% if is_music %>
    <tr><th>Genre</th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:genre] %>
        <%= form.radio_button(labe, i, checked: (i==0)) %>
        <%= form.label labe, em.genre.title_or_alt(langcode: I18n.locale), :value => i %>
      </td>
      <% end %>
    </tr>
    <tr><th>Year</th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:year] %>
        <%= form.radio_button(labe, i, checked: (i==0)) %>
        <%= form.label labe, em.year.inspect, :value => i %>
      </td>
      <% end %>
    </tr>
  <% else %>
    <tr><th>Sex</th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:sex] %>
        <%= form.radio_button(labe, i, checked: (i==0)) %>
        <%= form.label labe, em.sex.title_or_alt(langcode: I18n.locale), :value => i %>
      </td>
      <% end %>
    </tr>
    <tr><th>Birthday</th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:birthday] %>
        <%= form.radio_button(labe, i, checked: (i==0)) %>
        <%= form.label labe, em.birthday_string, :value => i %>
      </td>
      <% end %>
    </tr>
    <tr><th>Wikipedia[en]</th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:wiki_en] %>
        <%= form.radio_button(labe, i, checked: (i==0)) %>
        <%= form.label labe, em.wiki_en, :value => i %>
      </td>
      <% end %>
    </tr>
    <tr><th>Wikipedia[ja]</th>
      <% models.each_with_index do |em, i| %>
      <td>
        <% labe = BaseMergesController::FORM_MERGE[:wiki_ja] %>
        <%= form.radio_button(labe, i, checked: (i==0)) %>
        <%= form.label labe, em.wiki_ja, :value => i %>
      </td>
      <% end %>
    </tr>
  <% end %>
    <tr><th title="Notes are merged (combined).">Note</th>
      <% models.each_with_index do |em, i| %>
      <td>
        <%= em.note %>
      </td>
      <% end %>
    </tr>
  </tbody>
</table>

  <div class="actions">
    <%= form.submit t("Submit", default: "Submit") %>
  </div>
  <div class="actions">
  <%= submit_tag("Reset (Start Over)", { :name => 'reset', :id => 'reset_button', :type => "reset" }) %>
  </div>
<% end %>

